# コマンドシステムアーキテクチャ仕様書

## 概要
ADVツールとしての拡張性を確保するため、コマンドパターンを導入。
各コマンドを独立したクラスとして実装し、プラグイン形式で追加可能にする。

---

## 設計の目的

### 旧設計の問題点
- game_manager.gd の肥大化（全コマンドを1つのmatch文で管理）
- コマンド追加時に既存コードを修正する必要がある
- テストが困難
- ドキュメント化が手動

### 新設計の利点
- **拡張性**: 新規コマンド追加が容易
- **保守性**: 各コマンドが独立したファイル
- **テスタビリティ**: 個別にテスト可能
- **プラグイン対応**: 外部スクリプトから動的追加可能
- **自動ドキュメント生成**: コマンドリファレンスを自動生成

---

## アーキテクチャ概要

```
┌─────────────────┐
│  ScenarioFile   │
│  (demo.txt)     │
└────────┬────────┘
         │
         v
┌─────────────────────┐
│ ScenarioManager     │ コマンドをパース
│ _parse_bgm_command()│
└────────┬────────────┘
         │ Dictionary
         v
┌─────────────────────┐
│   GameManager       │
│ command_context構築 │
└────────┬────────────┘
         │
         v
┌─────────────────────┐
│ CommandRegistry     │ コマンドを実行
│ execute_command()   │
└────────┬────────────┘
         │
         v
┌─────────────────────┐
│  BgmCommand         │ 実際の処理
│  execute()          │ → AudioManager
└─────────────────────┘
```

---

## コンポーネント詳細

### 1. BaseCommand (基底クラス)

**ファイル**: `scripts/commands/base_command.gd`

全てのコマンドが継承する抽象クラス。

**メソッド**:
- `get_command_name() -> String`: コマンド名を返す
- `get_description() -> String`: コマンドの説明
- `execute(params: Dictionary, context: Dictionary)`: コマンド実行
- `requires_wait() -> bool`: 入力待ちが必要か
- `get_priority() -> int`: 実行優先度（将来用）

---

### 2. CommandRegistry (コマンド管理)

**ファイル**: `scripts/command_registry.gd`

全コマンドを登録・管理するシングルトン。

**主要メソッド**:

#### register_command(command: BaseCommand)
コマンドを登録。

```gdscript
register_command(BgmCommand.new())
```

#### execute_command(cmd_name: String, params: Dictionary, context: Dictionary) -> bool
コマンドを実行し、入力待ちが必要か返す。

```gdscript
var requires_wait = registry.execute_command("bgm", params, context)
```

#### generate_documentation() -> String
コマンドリファレンスを自動生成。

---

### 3. GameManager (簡略化)

**ファイル**: `scripts/game_manager.gd`

コマンド実行の制御のみに集中。

**主要な変更**:

#### 旧実装（60行以上のmatch文）
```gdscript
match command.get("type", ""):
    "bg":
        _change_background(...)
    "chara":
        character_display.show_character(...)
    "bgm":
        _play_bgm(...)
    # 50個以上のコマンド...
```

#### 新実装（1行）
```gdscript
var requires_wait = command_registry.execute_command(
    command_type, 
    command, 
    command_context
)
```

---

## 実装済みコマンド一覧

### BgCommand
- **コマンド名**: `@bg`
- **パラメータ**: `image` (画像名)
- **機能**: 背景画像を変更
- **待機**: なし

### CharaCommand
- **コマンド名**: `@chara`
- **パラメータ**: `id`, `expression`, `x`, `y`
- **機能**: キャラクター立ち絵を表示
- **待機**: なし

### CharaHideCommand
- **コマンド名**: `@chara_hide`
- **パラメータ**: `id`
- **機能**: キャラクター立ち絵を非表示
- **待機**: なし

### DialogueCommand
- **コマンド名**: `@dialogue` (内部用)
- **パラメータ**: `character`, `text`
- **機能**: 台詞を表示
- **待機**: あり（ユーザークリック待ち）

### BgmCommand
- **コマンド名**: `@bgm`
- **パラメータ**: `file`, `volume`, `loop`, `seek`, `restart`, `sprite_time`
- **機能**: BGMを再生
- **待機**: なし

### StopBgmCommand
- **コマンド名**: `@stopbgm`
- **パラメータ**: `file`, `time`
- **機能**: BGMを停止
- **待機**: なし

### StopSeCommand
- **コマンド名**: `@stopse`
- **パラメータ**: `file`, `time`
- **機能**: SEを停止
- **待機**: なし

---

## コンテキスト (Context) の仕組み

各コマンドが必要なリソースにアクセスできるよう、GameManagerが**コンテキスト**を提供。

### コンテキストの内容

```gdscript
command_context = {
    "message_window": MessageWindow,      # UI
    "background": TextureRect,            # 背景
    "character_display": CharacterDisplay,# キャラ
    "scenario_manager": ScenarioManager,  # シナリオ
    "game_manager": GameManager           # 自身
}
```

### コマンド内での使用例

```gdscript
func execute(params: Dictionary, context: Dictionary) -> void:
    var message_window = context.get("message_window")
    message_window.show_dialogue("キャラ", "台詞")
```

---

## 新規コマンドの追加方法

### 手順

#### 1. コマンドクラス作成

`scripts/commands/my_command.gd`:

```gdscript
extends BaseCommand
class_name MyCommand

func get_command_name() -> String:
    return "mycommand"

func get_description() -> String:
    return "私のカスタムコマンド"

func execute(params: Dictionary, context: Dictionary) -> void:
    print("実行！", params)

func requires_wait() -> bool:
    return false
```

#### 2. CommandRegistryに登録

`scripts/command_registry.gd` の `register_builtin_commands()`:

```gdscript
func register_builtin_commands():
    # ... 既存のコマンド
    register_command(MyCommand.new())  # 追加
```

#### 3. シナリオで使用

```
@mycommand param1 param2
```

これだけで完了！game_manager.gd は一切変更不要。

---

## プラグインシステム（将来の拡張）

### 外部スクリプトからのコマンド追加

```gdscript
# ユーザープラグイン
var plugin_script = load("user://plugins/special_effect.gd")
var command = plugin_script.new()
command_registry.register_command(command)
```

### コマンドのホットリロード

開発中にコマンドを再読み込み：

```gdscript
command_registry.commands.clear()
command_registry.register_builtin_commands()
```

---

## テスト方法

### 単体テスト例

```gdscript
# test_bgm_command.gd
func test_bgm_command():
    var cmd = BgmCommand.new()
    var params = {"file": "test_bgm", "volume": 80}
    var context = {"test": true}
    
    cmd.execute(params, context)
    
    # AudioManager が呼ばれたか検証
    assert(...)
```

---

## ドキュメント自動生成

### 実行方法

```gdscript
var doc = command_registry.generate_documentation()
print(doc)
```

### 出力例

```markdown
# ADVコマンドリファレンス

## @bg
背景画像を変更します。パラメータ: 画像名

## @bgm
BGMを再生します。volume, loop, seek, restart, sprite_time パラメータをサポート。

## @chara
キャラクター立ち絵を表示します。パラメータ: ID, 表情, x座標, y座標
...
```

---

## フォルダ構造

```
scripts/
├── commands/                 # コマンドクラス群
│   ├── base_command.gd      # 基底クラス
│   ├── bg_command.gd
│   ├── bgm_command.gd
│   ├── chara_command.gd
│   ├── chara_hide_command.gd
│   ├── dialogue_command.gd
│   ├── stopbgm_command.gd
│   └── stopse_command.gd
├── command_registry.gd       # コマンド管理
├── game_manager.gd           # 簡略化されたマネージャー
├── scenario_manager.gd       # パーサー
└── audio_manager.gd          # オーディオ処理
```

---

## 今後の拡張予定

### 選択肢システム
```gdscript
# scripts/commands/choice_command.gd
extends BaseCommand
class_name ChoiceCommand

func get_command_name() -> String:
    return "choice"

func requires_wait() -> bool:
    return true  # 選択待ち
```

### 複数メッセージウィンドウ
```gdscript
command_context = {
    "message_windows": {
        "main": MessageWindow1,
        "sub": MessageWindow2
    }
}
```

### アニメーションコマンド
```
@animate chara alice shake duration:1.0
@animate bg fade_out duration:2.0
```

### 条件分岐
```
@if flag_name == value
@endif
```

---

## パフォーマンス考慮

- コマンドクラスは軽量（RefCounted継承）
- 辞書検索は O(1)
- 実行時オーバーヘッドは無視できるレベル

---

## 実装日
2025年1月（初版）

## 関連ドキュメント
- musicコマンド拡張仕様書.md
- BGM_SE停止コマンド仕様書.md
- ADVデモ実装ログ.md
