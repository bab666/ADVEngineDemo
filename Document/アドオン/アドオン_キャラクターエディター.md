# キャラクターエディター実装仕様書

## 概要
キャラクターの定義、表情差分の管理、リアルタイムプレビュー機能を持つエディターツール。
表情はレイヤー方式で構成され、ベース立ち絵 + 眉/目/口などのパーツを重ねて表現する。

---

## データ構造

### CharacterData

**ファイル**: `scripts/character_data.gd`

キャラクター1体分のデータを保持するResourceクラス。

#### プロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| character_id | String | キャラクターの一意ID |
| display_name | String | 表示名 |
| nicknames | Array[String] | ニックネーム配列 |
| description | String | 説明文 |
| default_portrait | String | デフォルト表情名 |
| portrait_scale | float | 表示スケール (0.1〜3.0) |
| portrait_offset | Vector2 | 表示位置オフセット |
| mirror | bool | 左右反転するか |
| portraits | Dictionary | 表情データ (名前 -> PortraitData) |

---

### PortraitData

表情1つ分のデータ。

#### プロパティ

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| name | String | 表情名 |
| base_image | String | ベース立ち絵のパス |
| layers | Dictionary | レイヤー (レイヤー名 -> 画像パス) |

#### レイヤー名の規約

- `eyebrows`: 眉
- `eyes`: 目
- `mouth`: 口
- `extra`: その他エフェクト

描画順序: base_image → eyebrows → eyes → mouth → extra

---

## ファイル構成

```
resources/
├── characters_data/          # キャラクター定義JSON
│   ├── alice.json
│   ├── bob.json
│   └── ...
└── characters/
    ├── alice_base.png        # ベース立ち絵
    └── parts/                # パーツ素材
        ├── alice_eyebrows_normal.png
        ├── alice_eyes_normal.png
        ├── alice_mouth_normal.png
        ├── alice_eyes_happy.png
        └── ...

scripts/
├── character_data.gd         # データクラス
├── character_display.gd      # 表示システム (拡張版)
└── character_editor.gd       # エディターUI

scenes/editor/
└── character_editor.tscn     # エディター画面
```

---

## JSONフォーマット

### alice.json の例

```json
{
  "character_id": "alice",
  "display_name": "アリス",
  "nicknames": ["アリちゃん"],
  "description": "明るく元気な女の子",
  "default_portrait": "normal",
  "portrait_scale": 1.0,
  "portrait_offset": {"x": 0, "y": 0},
  "mirror": false,
  "portraits": {
    "normal": {
      "name": "normal",
      "base_image": "res://resources/characters/alice_base.png",
      "layers": {
        "eyebrows": "res://resources/characters/parts/alice_eyebrows_normal.png",
        "eyes": "res://resources/characters/parts/alice_eyes_normal.png",
        "mouth": "res://resources/characters/parts/alice_mouth_normal.png"
      }
    },
    "smile": {
      "name": "smile",
      "base_image": "res://resources/characters/alice_base.png",
      "layers": {
        "eyebrows": "res://resources/characters/parts/alice_eyebrows_raised.png",
        "eyes": "res://resources/characters/parts/alice_eyes_happy.png",
        "mouth": "res://resources/characters/parts/alice_mouth_smile.png"
      }
    }
  }
}
```

---

## エディター機能

### 基本情報タブ

- Character ID 入力
- Display Name 入力
- Description (複数行)
- Scale スライダー (0.1〜3.0)
- Mirror チェックボックス

### ポートレート管理

#### ポートレート一覧
- 登録済み表情の一覧表示
- 「+ 追加」ボタンで新規作成
- 選択で編集モードへ

#### ポートレート編集
- Portrait Name: 表情名を変更
- Base Image: ベース立ち絵を選択
- Layers:
  - Eyebrows (眉) 選択ボタン
  - Eyes (目) 選択ボタン
  - Mouth (口) 選択ボタン
  - Extra (その他) 選択ボタン

### プレビュー

右側パネルにリアルタイムプレビュー表示:
- 現在編集中の表情を表示
- Scale、Mirror設定を即座に反映
- レイヤーの重なりを確認

### 保存/読み込み

- **保存**: `resources/characters_data/{character_id}.json` に出力
- **読み込み**: 既存JSONからデータを読み込み

---

## CharacterDisplay拡張

### 機能

#### show_character() の動作

1. `resources/characters_data/{char_id}.json` を読み込み
2. 指定された表情データを取得
3. Node2Dを作成/取得
4. ベース画像をSprite2Dとして配置 (z_index: 0)
5. 各レイヤーをSprite2Dとして配置 (z_index: 1, 2, 3...)
6. Scale、Mirror設定を適用

#### フォールバック機能

JSONが存在しない場合、従来の単一画像方式で表示:
- `resources/characters/{char_id}_{expression}.png`

これにより既存のシナリオとの互換性を維持。

---

## シナリオからの使用

### 従来の方式 (互換性維持)

```
@chara alice normal 1920 540
```

JSONが無ければ `alice_normal.png` を使用。

### 新方式 (レイヤー対応)

```
@chara alice smile 1920 540
```

`alice.json` が存在すれば、`smile` 表情のレイヤーを自動合成。

---

## 素材作成ガイドライン

### ベース立ち絵

- 解像度: 2000x4000px 推奨 (4K対応)
- 形式: PNG (透過)
- **顔部分は透明**（パーツで描画）

### パーツ素材

#### 眉 (eyebrows)
- ベース立ち絵の顔位置に合わせる
- 透過PNG
- パターン: normal, raised, angry, sad など

#### 目 (eyes)
- ベース立ち絵の目位置に合わせる
- 透過PNG
- パターン: normal, happy, closed, surprised など

#### 口 (mouth)
- ベース立ち絵の口位置に合わせる
- 透過PNG
- パターン: normal, smile, frown, open など

#### その他 (extra)
- 涙、汗、エフェクトなど
- 透過PNG

---

## エディターの使い方

### 新規キャラクター作成

1. エディターシーン `character_editor.tscn` を開く
2. Character ID に固有IDを入力 (例: `alice`)
3. Display Name、Description を入力
4. 「+ 追加」で表情を追加
5. 表情を選択して編集:
   - Base Image を選択
   - 各レイヤー (eyebrows, eyes, mouth) を選択
6. プレビューで確認
7. 「保存」ボタンで JSON 出力

### 既存キャラクター編集

1. エディターシーン開く
2. 「読み込み」ボタン (要実装)
3. Character ID 入力
4. 編集
5. 「保存」で上書き

---

## 今後の拡張

### エディター機能

- [ ] ドラッグ&ドロップでのレイヤー追加
- [ ] プレビューでのアニメーション再生
- [ ] 表情のコピー/ペースト機能
- [ ] 一括パーツ差し替え
- [ ] エクスポート機能 (全表情をプレビュー画像として出力)

### データ機能

- [ ] アニメーション定義 (まばたき、口パクなど)
- [ ] 表情のトランジション設定
- [ ] レイヤーの位置微調整
- [ ] レイヤーの透明度設定
- [ ] カスタムレイヤーの追加

### シナリオ連携

- [ ] 表情をスムーズに変化させるコマンド
  ```
  @chara_morph alice normal smile duration:0.5
  ```
- [ ] レイヤー個別操作
  ```
  @chara_layer alice eyes closed
  ```

---

## パフォーマンス考慮

### キャッシュ機構

- CharacterData は初回読み込み後キャッシュ
- 同じキャラクターの表情切り替えは高速

### メモリ管理

- 使用していないキャラクターのテクスチャは解放
- レイヤー数に応じた動的なSprite2D生成

---

## テスト手順

### 手動テスト

1. キャラクターエディターでキャラクター作成
2. 複数の表情を定義
3. 各レイヤーに異なる画像を設定
4. プレビューで表示確認
5. 保存後、ゲームシーンで `@chara` コマンドで呼び出し
6. 表情が正しく表示されるか確認

### 互換性テスト

1. JSONを作成せず従来の単一画像を配置
2. `@chara alice normal` で呼び出し
3. フォールバックが動作するか確認

---

## 実装日
2025年1月（初版）

## 関連ドキュメント
- コマンドシステムアーキテクチャ仕様書.md
- ADVデモ実装ログ.md
